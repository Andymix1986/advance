<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>King Play</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* (Todo tu CSS original intacto) */
body {
  margin: 0;
  background-color: #000;
  font-family: sans-serif;
  color: #fff;
  overflow-x: hidden;
}
/* ... resto de estilos sin cambios ... */
</style>
</head>
<body>

<!-- Carrusel -->
<div class="carousel-wrapper">
  <div class="carousel-container" id="carousel-container">
    <img class="carousel-image active" src="https://images2.imgbox.com/41/0a/d5N9fJDY_o.jpg" alt="Carrusel 1" loading="lazy">
    <img class="carousel-image" src="https://images2.imgbox.com/51/6e/9xuKLLlO_o.jpg" alt="Carrusel 2" loading="lazy">
    <img class="carousel-image" src="https://images2.imgbox.com/87/ce/T0um6IwN_o.jpg" alt="Carrusel 3" loading="lazy">
  </div>
</div>

<!-- Pop-up de actualización -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup" id="popup">
    <h2>Hay una nueva versión disponible</h2>
    <button id="updateButton">Actualizar</button>
  </div>
</div>

<!-- Contenedor de sliders -->
<div id="sliders"></div>

<!-- Overlay de carga -->
<div id="loadingOverlay" style="display:none;">
  <div style="color: white; text-align: center;">
    <p>Por favor espera mientras se carga el anuncio...</p>
    <button id="continueBtn" style="display:none;">Abrir reproductor ahora</button>
  </div>
</div>

<script>
// Carrusel
let current = 0;
const images = document.querySelectorAll(".carousel-image");
setInterval(() => {
  images[current].classList.remove("active");
  current = (current + 1) % images.length;
  images[current].classList.add("active");
}, 4000);

// XOR + Base64
function xorDecrypt(input, key) {
  let output = '';
  for (let i = 0; i < input.length; i++) {
    const charCode = input.charCodeAt(i) ^ key.charCodeAt(i % key.length);
    output += String.fromCharCode(charCode);
  }
  return output;
}
function decodeBase64(input) {
  return atob(input);
}

const JSON_URL = "https://raw.githubusercontent.com/Andymix1986/king-play/refs/heads/main/novelas.json";
const storedVersion = localStorage.getItem('version') || '1.0.0';
let newVersionFromJson = storedVersion;

function compareVersions(currentVersion, newVersion) {
  const current = currentVersion.split('.').map(Number);
  const next = newVersion.split('.').map(Number);
  for (let i = 0; i < 3; i++) {
    if (next[i] > current[i]) return true;
    if (next[i] < current[i]) return false;
  }
  return false;
}

function showPopup(message) {
  const popupMessage = document.querySelector("#popup h2");
  popupMessage.textContent = message;
  document.getElementById("popupOverlay").style.display = "flex";
}

document.getElementById("updateButton").addEventListener("click", () => {
  localStorage.setItem('version', newVersionFromJson);
  location.reload();
});

document.addEventListener("DOMContentLoaded", function () {
  fetch(JSON_URL)
    .then(response => response.text())
    .then(data => {
      const decryptedData = xorDecrypt(decodeBase64(data), "andymix1986");
      const parsedData = JSON.parse(decryptedData);
      newVersionFromJson = parsedData.version;
      if (compareVersions(storedVersion, newVersionFromJson)) showPopup(parsedData.mensaje);

      const container = document.getElementById("sliders");
      const chunkSize = 7;
      for (let i = 0; i < parsedData.novelas.length; i += chunkSize) {
        const chunk = parsedData.novelas.slice(i, i + chunkSize);
        const slider = document.createElement("div");
        slider.className = "slider";
        slider.innerHTML = `<h2>Novelas</h2>`;
        const row = document.createElement("div");
        row.className = "slider-row";
        row.tabIndex = 0;
        chunk.forEach(novela => {
          const card = document.createElement("div");
          card.className = "card";
          card.tabIndex = 0;
          card.setAttribute("data-type", novela.tipo);
          card.setAttribute("data-base-url", novela.url);
          card.setAttribute("data-id", novela.id || "");
          card.setAttribute("data-titulo", novela.titulo || "");
          card.setAttribute("data-total", novela.total || "");
          const img = document.createElement("img");
          img.src = novela.imagen;
          img.alt = novela.titulo;
          img.loading = "lazy";
          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = novela.titulo;
          card.appendChild(img);
          card.appendChild(title);
          row.appendChild(card);
        });
        slider.appendChild(row);
        container.appendChild(slider);
      }
    })
    .catch(error => console.error("Error cargando el archivo JSON:", error));
});

document.addEventListener("DOMContentLoaded", function () {
  document.body.addEventListener("click", function (e) {
    const card = e.target.closest('.card');
    if (!card) return;

    const type = card.getAttribute('data-type');
    const overlay = document.getElementById("loadingOverlay");
    const continueBtn = document.getElementById("continueBtn");

    // Mostrar el overlay y ocultar el botón por defecto
    overlay.style.display = "flex";
    continueBtn.style.display = "none";

    // ABRIR anuncio inmediatamente al click (evita bloqueo del navegador)
    window.open("https://example.adterra.link", "_blank");

    // Mostrar botón para continuar luego de 5 segundos
    setTimeout(() => {
      continueBtn.style.display = "block";
    }, 5000);

    continueBtn.onclick = () => {
      if (type === "LOC") {
        const baseUrl = card.getAttribute('data-base-url');
        const id = card.getAttribute('data-id');
        const titulo = card.getAttribute('data-titulo');
        const total = card.getAttribute('data-total');

        const url = `https://andymix1986.github.io/KING-PLAYER-ONLINE/player_0000.html?urlbase=${encodeURIComponent(baseUrl)}&id=${id}&titulo=${encodeURIComponent(titulo)}&total=${total}`;
        window.location.href = url;
      } else if (type === "EXT") {
        const externalUrl = card.getAttribute('data-base-url');
        window.location.href = externalUrl;
      }
    };

    // Ocultar overlay después de 15s por seguridad
    setTimeout(() => {
      overlay.style.display = "none";
    }, 15000);
  });
});

</script>

</body>
</html>
